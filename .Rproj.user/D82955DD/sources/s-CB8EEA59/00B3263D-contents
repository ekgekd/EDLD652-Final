---
title: "EDLD 652 Homework"
author: "Eliott Doyle, Diana DeWald"
date: "2/8/2022"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggrepel)
library(gghighlight)
library(ggtext)
library(ggforce)
library(geomtextpath)

transit_cost <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-01-05/transit_cost.csv')

```

# Question 1: Use the transit costs data to reproduce the following plot. To do so, you will need to do a small amount of data cleaning, then calculate the means and standard errors (of the mean) for each country. Please filter to only counties with at least three observations. To use actual country names, rather than abbreviations, join your dataset with the output from the following

```{r q1, echo = FALSE, warning = FALSE, message = FALSE}

# removing the last 7 rows which contain many NA values

transit_cost <- transit_cost[-c(538, 539, 540, 541, 542, 543, 544), ]

library(countrycode)

country_codes <- countrycode::codelist %>% 
  select(country_name = country.name.en, country = ecb)


# joining datasets by country codes and removing other NAs
transit_new <- left_join(transit_cost, country_codes, by = "country")

transit_new <- transit_new[-c(141, 481, 482), ]

transit_new <-  subset(transit_new, select = -c(reference, end_year) )

# removing countries with less than 3 observations
transit_new <- transit_new %>%
  group_by(country_name) %>% 
  filter(n() >= 3)

transit_new$real_cost <- as.numeric(transit_new$real_cost)
transit_new$country_name <- as.factor(transit_new$country_name)

# adding mean and standard deviation columns
transit_new.1 <- transit_new %>%
  group_by(country_name) %>%
  summarize(mean_realcost = mean(real_cost, na.rm = TRUE),
            sd_realcost = sd(real_cost, na.rm = TRUE))
  
# adding standard error column

transit_new <- transit_new %>%
  group_by(country_name) %>%
  summarize(mean_realcost = mean(real_cost, na.rm = TRUE),
            sd_realcost = sd(real_cost, na.rm = TRUE))

  transit_new.1 <- transit_new %>%
    group_by(country_name) %>%
    mutate(sem_realcost = mean(sd_realcost)/sqrt(length(transit_new[])))
  
  
# preparing the plot
  
x <- c(10000, 20000, 30000)
cost <- data.frame(x)

se.1 <- (transit_new.1$mean_realcost - transit_new.1$sem_realcost)
se.2 <- (transit_new.1$mean_realcost + transit_new.1$sem_realcost)


transit_1 <- transit_new.1 %>% 
  ggplot(aes(x = mean_realcost,
             y = reorder(country_name, mean_realcost))) +
  geom_point(color = "cornflowerblue", size = 2) +
  xlim(0, 30000) +
  theme_classic() +
  labs(
    title = "Cost to build transit systems vary across countries",
    x = "Real Cost (In millions of dollars)",
    y = "Country",
    caption = "Data provided through #tidytuesday by the Transit Costs Project") +
    geom_linerange(aes(xmin= se.1, xmax= se.2)) +
    theme(plot.title = element_text(hjust = -0.9, vjust=2.12)) + 
    theme(plot.caption=element_text(size=10, hjust= 0.5)) +
    geom_vline(data = cost, aes(xintercept = x), color = "darkgrey")


transit_1  


```


# Question 2: Visualize the same relation, but displaying the uncertainty using an alternative method of your choosing.

```{r q2, echo = FALSE, warning = FALSE, message = FALSE}

# using standard deviation rather than standard error to visualize uncertainty:
sd.1 <- (transit_new.1$mean_realcost - transit_new.1$sd_realcost)
sd.2 <- (transit_new.1$mean_realcost + transit_new.1$sd_realcost)

transit_2 <- transit_new.1 %>% 
  ggplot(aes(x = mean_realcost,
             y = reorder(country_name, mean_realcost))) +
  geom_point(color = "aquamarine4", size = 2) +
  xlim(0, 30000) +
  theme_classic() +
  labs(
    title = "Cost to build transit systems vary across countries",
    x = "Real Cost (In millions of dollars)",
    y = "Country",
    caption = "Horizontal lines represent standard deviation") +
    geom_linerange(aes(xmin= sd.1, xmax= sd.2)) +
    theme(plot.title = element_text(hjust = -0.9, vjust=2.12)) + 
    theme(plot.caption=element_text(size=10, hjust= 0.5)) +
    geom_vline(data = cost, aes(xintercept = x), color = "darkgrey")

transit_2


```







# Question 3: Compute the mean length and real_cost by city. Reproduce the following plot.

### Hint: Look into scale_size_binned()

```{r q3, echo = FALSE, warning = FALSE, message = FALSE}
#View(transit_new)
#View(transit_cost)
#mean length and realcost by city
q3 <- transit_cost %>% 
  select(country, city, length, real_cost) %>% 
  group_by(country, city)
q3$real_cost <- as.numeric(q3$real_cost)
#View(q3)
#head(q3)
q3_calc <- q3 %>% 
  summarize(mean_length = mean(length, na.rm = TRUE),
         mean_real_cost = mean(real_cost, na.rm = TRUE),
         count=n()) 
#View(q3_calc)
q3_fig <- q3_calc %>% 
  ggplot(aes(x = mean_length,
             y = mean_real_cost
             )) +
  geom_point(aes(size = count), color = "#b452cd") +
  scale_size_binned() +
  gghighlight(country == "IN") +
  geom_text_repel(data = dplyr::filter(q3_calc,
                                country == "IN"),
                  aes(label = city),
                  min.segment.length = 0,
                  box.padding = 0.2) +
  scale_x_log10() +
  scale_y_log10(labels = scales::dollar_format()) +
  theme_minimal(base_size = 14) +
  labs(title = "Longer transit systems tend to cost more",
       subtitle = "<span style = 'color: #b452cd'>India</span> has among the most transit systems in the world",
       x = "Average length",
       y = "Average cost",
       caption = "Note the log transformations to the axes",
       size = "Number of transit systems") +
  theme(plot.title.position = "plot", #to left-align title
        plot.caption.position =  "plot", # & subtitle
        legend.position="bottom",
        plot.subtitle = element_markdown()) #needed to get subtitle color to work
q3_fig
```


# Question 4:Using basically the same data, reproduce the following plot. Note youâ€™ll need the country_name column in your dataset.


```{r q4, echo = FALSE, warning = FALSE, message = FALSE}
# new df, joining by country codes
q4_calc <- q3_calc
q4_calc <- left_join(q4_calc, country_codes, by = "country")
#View(q4_calc)
q4_fig <- q4_calc %>% 
  ggplot(aes(x = mean_length,
             y = mean_real_cost
             )) +
  geom_point(aes(size = count), color = "#5C98AD") +
  geom_mark_ellipse(aes(group = country_name, label = country_name),
                    color = "#F7B2C1",
                    data = filter(drop_na(q4_calc),
                                  country_name == "United States"),
                    size = .5,
                    con.colour = "#F7B2C1",
                    con.size = .3,
                    con.type = "straight",
                    label.colour = "#5C98AD",
                    show.legend = FALSE) +
  geom_label_repel(data = dplyr::filter(q4_calc,
                                country == "US"),
    aes(label = city),
    box.padding = 0.35,
    min.segment.length = 0,
    point.padding = 0.5
  ) +
  guides(color = "none") +
  scale_size_binned() +
  gghighlight(country_name == "United States") +
  scale_x_log10() +
  scale_y_log10(labels = scales::dollar_format()) +
  theme_minimal(base_size = 14) +
  labs(title = "Longer transit systems tend to cost more",
       x = "Average length",
       y = "Average cost",
       caption = "Note the log transformations to the axes",
       size = "Number of transit systems") +
  theme(plot.title.position = "plot",
        plot.caption.position =  "plot",
        legend.position="bottom",
        plot.subtitle = element_markdown()) 
q4_fig
```



# Question 5:Use the crime dataset to run the following code and fit the corresponding model. Note, it may take a moment to run.

```{r q5, echo = FALSE, warning = FALSE, message = FALSE}
# model_data <- crime %>% 
#  mutate(neighborhood_id = relevel(factor(neighborhood_id), ref = "barnum"))
# m <- glm(is_crime ~ neighborhood_id, 
#         data = model_data,
#         family = "binomial")
# tidied <- broom::tidy(m)
# ppoints(20)
# regis <- tidied %>% 
#  filter(term == "neighborhood_idregis")
# qnorm(ppoints(20), 
#      mean = regis$estimate,
#      sd = regis$std.error)
```